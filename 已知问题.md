# 已知问题（Known Issues）

更新时间：2026-02-05

本文档基于当前代码与已有审查结论整理，用于公开说明已确认问题、影响范围与临时规避建议。

## 已修复

### ~~时区处理存在全局副作用~~（已修复）

- 已改为使用 `new Date(year, month-1, day, 12, 0, 0)` 数值构造函数，不再依赖 `process.env.TZ`。

### ~~农历日期验证逻辑与公历校验耦合~~（已修复）

- `normalizeYmd` 现在接受 `isLunar` 参数，农历日期跳过公历回环校验，仅做基本范围检查（月 1-12，日 1-30），由 iztro 负责最终校验。

### ~~输出 JSON 冗余过大~~（已修复）

- 移除了 `natal`（原始 astrolabe dump）、`current`、`future` 原始字段。
- 新增 `natalSummary`（命盘元数据摘要）。
- 移除宫位中重复的 `flowStars` 字段，仅保留 `flowStarsByRole`。

## 当前已知问题

### 1. 自动化测试覆盖有限

- 位置：`scripts/test.mjs`
- 现状：有基础结构验证和输入校验测试，但未覆盖星曜计算正确性
- 风险：星曜数据回归需依赖人工比对
- 优先级：中
- 临时规避：每次改动后运行 `node test.mjs` 确保结构正确，重要改动另行比对样例输出

### 2. 单函数职责偏重，维护成本高

- 位置：`scripts/iztro_runner.mjs` 的宫位构建逻辑
- 现状：已拆分为多个子函数（`buildPalaceEntry`、`buildFlowStarsByRole` 等），但整体仍在单文件中
- 风险：文件持续增长后可读性下降
- 优先级：低
- 临时规避：改动时保持输出结构不变

## 不属于当前问题的说明

- 文档中"默认不做真太阳时修正"的行为在代码输出策略中已有明确免责声明。
- `birthplace` 当前约束为"必填非空字符串"，与现有 schema 描述一致。
