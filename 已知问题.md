# 已知问题（Known Issues）

更新时间：2026-02-06

本文档基于当前代码与已有审查结论整理，用于公开说明已确认问题、影响范围与临时规避建议。

## 1. 时区处理存在全局副作用

- 位置：`scripts/iztro_runner.mjs`
- 现状：通过设置 `process.env.TZ` 影响日期处理
- 风险：并发或同进程多任务场景下，可能出现时区相互污染
- 优先级：高
- 临时规避：单进程串行运行，避免在同一 Node 进程内混用多个时区请求

## 2. 农历日期验证逻辑与公历校验耦合

- 位置：`scripts/iztro_runner.mjs` 的日期标准化逻辑
- 现状：统一使用公历有效性校验，可能提前拒绝部分本应由 `iztro` 处理的农历输入
- 风险：某些合法农历日期被误判为非法
- 优先级：高
- 临时规避：农历输入优先使用已验证样例，异常时改由 `iztro` 侧实际可解析范围确认

## 3. 错误信息分类较粗

- 位置：`scripts/iztro_runner.mjs` 中 `iztro` 导入与输入失败分支
- 现状：不同错误（未安装、导入失败、API不兼容）文案区分不够细
- 风险：排障效率偏低
- 优先级：中
- 临时规避：结合 Node 报错原文和运行环境（Node版本、依赖版本）定位

## 4. 详细输出构建存在冗余拷贝

- 位置：`scripts/iztro_runner.mjs` 中 `flowStarsByRole` 构建逻辑
- 现状：同一数据存在额外克隆步骤
- 风险：在多日期批量计算时增加不必要开销
- 优先级：中
- 临时规避：控制 `futureDates` 数量，避免一次传入过多日期

## 5. 自动化测试缺失

- 位置：仓库当前无单元/集成测试文件
- 现状：主要依赖手动样例输出比对
- 风险：重构回归风险较高
- 优先级：中
- 临时规避：每次改动后至少回归 `example.input.json` 与 1-2 个真实样例

## 6. 单函数职责偏重，维护成本高

- 位置：`scripts/iztro_runner.mjs` 的详细宫位构建函数
- 现状：函数行数较长，聚合了映射构建、星曜整理、输出组装等职责
- 风险：新增需求时更容易引入隐性回归
- 优先级：中
- 临时规避：改动时先做小范围重构并保持输出结构不变

## 不属于当前问题的说明

- 文档中“默认不做真太阳时修正”的行为在代码输出策略中已有明确免责声明。
- `birthplace` 当前约束为“必填非空字符串”，与现有 schema 描述一致。

